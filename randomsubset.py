import os
from random import *
import pandas as pd
import shutil
import py7zlib

unzip_dir = "/media/zqz/Newsmy"
rs = Random()
rs.seed(1)

trainlabels = pd.read_csv('trainLabels.csv')
fids = []
opd = pd.DataFrame()
for clabel in range (1,4):
    mids = trainlabels[trainlabels.Class == clabel]
    mids = mids.reset_index(drop=True)

    rchoice = [i for i in range(333)]
    #print(rchoice)
    
#     for i in rchoice:
#         fids.append(mids.loc[i].Id)
#         opd = opd.append(mids.loc[i])

    rids = [mids.loc[i].Id for i in rchoice]
    fids.extend(rids)
    opd = opd.append(mids.loc[rchoice])
    
print(len(fids))
opd = opd.reset_index(drop=True)
opd.to_csv(os.path.join(unzip_dir, 'subtrainLabels.csv'), encoding='utf-8', index=False)

"""
sbase = '/home/zqz/Documents/virus/data/'
tbase = '/home/zqz/Documents/virus/subdata/'

for fid in fids:
	fnames = ['{0}.asm'.format(fid),'{0}.bytes'.format(fid)]
	for fname in fnames:
		cspath = sbase + fname
		ctpath = tbase + fname
		try:
			shutil.copy(cspath,ctpath)
		except:
			pass
"""
fp = open("/media/zqz/Newsmy/train.7z", 'rb')
zfile = py7zlib.Archive7z(fp)
#if not os.path.exists(unzip_dir):
#    os.mkdir(unzip_dir)
#if not os.path.exists(os.path.join(unzip_dir, "train")):
#    os.mkdir(os.path.join(unzip_dir, "train"))

index = 1
for fid in fids:
    fnames = ['train/{0}.asm'.format(fid), 'train/{0}.bytes'.format(fid)]
    for fname in fnames:
        unzip_file = os.path.join(unzip_dir, fname)
        if os.path.exists(unzip_file):
            continue
        try:
            data = zfile.getmember(fname).read()
            with open(unzip_file, "wb+") as f:
                f.write(data)
            del data
        except:
            print("error  id="+str(index))
    print("extract {0}  id=".format(fid) + str(index))
    index += 1

