import os
import numpy as np
from collections import *
import pandas as pd
from PIL import Image
import subprocess

rootpath = "/media/zqz/Newsmy/"
basepath = "/media/zqz/Newsmy/train/"
imgpath = "/media/zqz/Newsmy/img/"
mapimg = defaultdict(list)
subtrain = pd.read_csv(os.path.join(rootpath,'subtrainLabels.csv'))
test = pd.read_csv(os.path.join(rootpath, 'imgfeature.csv'), usecols=[0])
test = np.array(test).transpose()[0]

i = 0
p = 0
for sid in subtrain.Id:
    i += 1
    if sid in test:
        print(sid + " pass")
        continue
    print("computing {0}th img GIST...".format(str(i)))

    imgname = imgpath + sid + ".ppm"
    try:
        sub = subprocess.Popen("/home/zqz/Documents/lear_gist-1.2/compute_gist "+imgname, shell=True, stdout = subprocess.PIPE)
        sub.wait()
        feature = [ float(x) for x in sub.stdout.read().decode('utf8').split(' ')[:-1] ]
    except:
        feature = [0.1] * 960
    mapimg[sid] = feature

print(i,p)
dataframelist = []
for sid,imf in mapimg.items():
    standard = {}
    standard["Id"] = sid
    for index in range(len(imf)):
        colName = "pix{0}".format(str(index))
        standard[colName] = imf[index]
    dataframelist.append(standard)

df = pd.DataFrame(dataframelist)
df.to_csv(os.path.join(rootpath,"byteimgfeature.csv"),index=False)

